# 第一阶段：使用 Maven 构建 WAR 文件
FROM maven:3.9-eclipse-temurin-17 as builder

WORKDIR /build

# 复制整个项目源码
COPY . .

# 执行 Maven 构建，生成 target/app.war
RUN mvn clean package -DskipTests

# 第二阶段：使用 Tomcat 基础镜像部署 WAR
FROM tomcat:9.0-jdk17-temurin

# 删除 Tomcat 默认应用
RUN rm -rf /usr/local/tomcat/webapps/ROOT

# 从构建阶段复制生成的 WAR 文件，重命名为 ROOT.war
COPY --from=builder /build/target/app.war /usr/local/tomcat/webapps/ROOT.war

# 暴露端口
EXPOSE 8080

# 启动 Tomcat
CMD ["catalina.sh", "run"]
